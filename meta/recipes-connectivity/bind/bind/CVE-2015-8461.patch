From adbf81335b67be0cebdcf9f1f4fcb38ef4814f4d Mon Sep 17 00:00:00 2001
From: Mark Andrews <marka@isc.org>
Date: Thu, 25 Jun 2015 18:36:27 +1000
Subject: [PATCH] 4146.   [bug]           Address reference leak that could
 prevent a clean                         shutdown. [RT #37125]

Upstream-Status: Backport

https://source.isc.org/cgi-bin/gitweb.cgi?p=bind9.git;a=commit;h=adbf81335b67be0cebdcf9f1f4fcb38ef4814f4d

CVE: CVE-2015-8461
Signed-off-by:  Armin Kuster <akuster@mvista.com>
---
 CHANGES            | 3 +++
 lib/dns/resolver.c | 5 +++++
 2 files changed, 8 insertions(+)

Index: bind-9.9.5/lib/dns/resolver.c
===================================================================
--- bind-9.9.5.orig/lib/dns/resolver.c
+++ bind-9.9.5/lib/dns/resolver.c
@@ -1570,6 +1570,11 @@ fctx_query(fetchctx_t *fctx, dns_adbaddr
 	if (query->dispatch != NULL)
 		dns_dispatch_detach(&query->dispatch);
 
+	LOCK(&res->buckets[fctx->bucketnum].lock);
+	INSIST(fctx->references > 1);
+	fctx->references--;
+	UNLOCK(&res->buckets[fctx->bucketnum].lock);
+
  cleanup_query:
 	if (query->connects == 0) {
 		query->magic = 0;
Index: bind-9.9.5/CHANGES
===================================================================
--- bind-9.9.5.orig/CHANGES
+++ bind-9.9.5/CHANGES
@@ -1,4 +1,7 @@
 	--- 9.9.6-P2 released ---
+4146.  [bug]           Address reference leak that could prevent a clean
+                       shutdown. [RT #37125]
+
 
 4053.	[security]	Revoking a managed trust anchor and supplying
 			an untrusted replacement could cause named
